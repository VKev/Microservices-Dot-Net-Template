name: Nuke AWS (except ECR)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type NUKE to confirm irreversible deletion (except ECR)"
        required: true
        default: ""

permissions:
  id-token: write  # for OIDC to AWS
  contents: read

jobs:
  nuke:
    name: aws-nuke
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm == 'NUKE' }}
    env:
      AWS_REGION: us-east-1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_NUKE_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get AWS Account ID
        id: acct
        shell: bash
        run: |
          echo "account_id=$(aws sts get-caller-identity --query Account --output text)" >> "$GITHUB_OUTPUT"

      - name: Show account ID
        run: echo "Target Account: ${{ steps.acct.outputs.account_id }}"

      - name: Install aws-nuke
        shell: bash
        run: |
          VERSION=2.25.0
          curl -sSL -o aws-nuke.tgz https://github.com/rebuy-de/aws-nuke/releases/download/v${VERSION}/aws-nuke-v${VERSION}-linux-amd64.tar.gz
          tar -xzf aws-nuke.tgz
          sudo mv aws-nuke-v${VERSION}-linux-amd64/aws-nuke /usr/local/bin/aws-nuke
          aws-nuke version

      - name: Build final config (inject account ID)
        id: buildcfg
        shell: bash
        run: |
          BASE=Terraform/aws_nuke/nuke-config.yaml
          FINAL=Terraform/aws_nuke/nuke-config.final.yaml
          ACCOUNT_ID="${{ steps.acct.outputs.account_id }}"
          cp "$BASE" "$FINAL"
          {
            echo "bypass-alias-check-accounts:";
            echo "  - \"$ACCOUNT_ID\"";
            echo "";
            echo "accounts:";
            echo "  \"$ACCOUNT_ID\": {}";
          } >> "$FINAL"
          echo '----- Final Config -----'
          cat "$FINAL"

      - name: Run aws-nuke (DESTRUCTIVE)
        shell: bash
        run: |
          aws-nuke -c Terraform/aws_nuke/nuke-config.final.yaml --no-dry-run --force --force-sleep 3 --no-alias-check --quiet

      - name: Finished
        run: echo "Nuke completed"