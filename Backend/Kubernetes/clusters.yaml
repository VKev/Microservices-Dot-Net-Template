kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
name: microservices-local
kubeadmConfigPatches:
  # Simulate t3.small (2 vCPU, 2 GiB) by reserving a portion of node resources
  # for system/kube components and tightening eviction thresholds.
  - |
    kind: InitConfiguration
    apiVersion: kubeadm.k8s.io/v1beta3
    nodeRegistration:
      kubeletExtraArgs:
        system-reserved: "cpu=300m,memory=300Mi"
        kube-reserved: "cpu=300m,memory=300Mi"
        eviction-hard: "memory.available<256Mi,nodefs.available<10%"
        max-pods: "40"
  - |
    kind: JoinConfiguration
    apiVersion: kubeadm.k8s.io/v1beta3
    nodeRegistration:
      kubeletExtraArgs:
        system-reserved: "cpu=300m,memory=300Mi"
        kube-reserved: "cpu=300m,memory=300Mi"
        eviction-hard: "memory.available<256Mi,nodefs.available<10%"
        max-pods: "40"
nodes:
  - role: control-plane
    extraPortMappings:
      # API Gateway (NodePort 32080 -> host 2406)
      - containerPort: 32080
        hostPort: 2406
        protocol: TCP
      # Guest/User services (NodePorts 30001/30002)
      - containerPort: 30001
        hostPort: 5001
        protocol: TCP
      - containerPort: 30002
        hostPort: 5002
        protocol: TCP
      # Redis, RabbitMQ, Postgres
      - containerPort: 30379
        hostPort: 6379
        protocol: TCP
      - containerPort: 30672
        hostPort: 5672
        protocol: TCP
      - containerPort: 31672
        hostPort: 15672
        protocol: TCP
      - containerPort: 30032
        hostPort: 5432
        protocol: TCP
      # n8n (NodePort 32078 -> host 5678)
      - containerPort: 32078
        hostPort: 5678
        protocol: TCP
  - role: worker
  - role: worker
  - role: worker
